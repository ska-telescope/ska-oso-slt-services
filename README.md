Shift Log Tool Services
================================

The Shift log Tool Services is the server component of the
Shift Log Tool. It provides the web services used by the
Shift Log Tool client to read and manipulate stored
shift log data.

# Quick start
To clone this repository, run

```
git clone --recurse-submodules git@gitlab.com:ska-telescope/oso/ska-oso-slt-services.git
```

To refresh the GitLab Submodule, execute below commands:

```
git submodule update --recursive --remote
git submodule update --init --recursive
```

### Build and test

Install dependencies with Poetry and activate the virtual environment

```
poetry install
poetry shell
```

To build a new Docker image for the OET, run

```
make oci-build
```

Execute the test suite and lint the project with:

```
make python-test
make python-lint
```

To run a helm chart unit tests to verify helm chart configuration:

```
helm plugin install https://github.com/helm-unittest/helm-unittest.git
make k8s-chart-test
```

### Deploy to Kubernetes

Install the Helm umbrella chart into a Kubernetes cluster with ingress enabled:

```
make k8s-install-chart
```

The Swagger UI should be available external to the cluster at `http://<KUBE_HOST>/<KUBE_NAMESPACE>/slt/api/v1/ui/` and the API accesible via the same URL.

If using minikube, `KUBE_HOST` can be found by running `minikube ip`. 
`KUBE_NAMESPACE` is the namespace the chart was deployed to, likely `ska-oso-slt-services`

To run the component tests in a k8s pod:

```
make k8s-test
```

To uninstall the chart, run

```
make k8s-uninstall-chart
```

# Deployments from CICD

### Deploying to non-production environments

There are 3 different environments which are defined through the standard pipeline templates. They need to be manually triggered in the Gitlab UI.

1. `dev` - a temporary (4 hours) deployment from a feature branch, using the artefacts built in the branch pipeline
2. `integration` - a permanent deployment from the main branch, using the latest version of the artefacts built in the main pipeline
3. `staging` - a permanent deployment of the latest published artefact from CAR

To find the URL for the environment, see the 'info' job of the CICD pipeline stage, which should output the URL alongside the status of the Kubernetes pods.
Generally the API URL should be available at  `https://k8s.stfc.skao.int/$KUBE_NAMESPACE/slt/api/v1`


# Development

The API for this service is defined by an [OpenAPI document](src/ska_oso_slt_services/openapi/slt-openapi-v1.yaml).
This had been used to generate parts of the code used by the application using Swagger Codegen, name those in the [generated package](src/ska_oso_slt_services/slt/generated)
As the data models used by SKA evolve, the component in the OpenAPI document should be updated, and new Python models can be generated by running `make models`. Please do not update these files manually.

# Documentation

[![Documentation Status](https://readthedocs.org/projects/ska-telescope-ska-oso-slt-services/badge/?version=latest)](https://ska-telescope-ska-oso-slt-services.readthedocs.io/en/latest/)

To build the html version of the documentation, start 
from the root directory and first install the dependency using 
``poetry install --only docs`` and then type ``make docs-build html``. Read the documentation by pointing your browser
at ``docs/build/html/index.html``.
